<!-- START OF CUSTOM PLAYER EMBED CODE - TIER 3: NEON ORACLE -->

<style>
/* --- BASIC SETUP & THEME - TIER 3 NEON ORACLE --- */
:root {
    --brand-color: #00FFFF; /* Neon Cyan/Aqua */
    --background-color: #121212;
    --surface-color: #000000; 
    --text-color-primary: #FFFFFF;
    --text-color-secondary: #B3B3B3;
    --slider-track-color: #404040;
    --tier-accent: #00FFFF;
    --oracle-glow: rgba(0, 255, 255, 0.3);
}

/* The body styles won't apply inside an embed, so we style the container directly */
#custom-player-container {
    background-color: var(--surface-color);
    color: var(--text-color-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    border: 2px solid var(--tier-accent);
    padding: 24px;
    box-shadow: 0 8px 32px var(--oracle-glow), 0 0 20px var(--oracle-glow);
    overflow: hidden;
    margin: 40px auto;
    position: relative;
}

/* Enhanced Tier Badge for Oracle */
.tier-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, var(--tier-accent), rgba(0, 255, 255, 0.8));
    color: black;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 0 0 10px var(--oracle-glow);
}

/* --- HIDE THE DEFAULT PLYR PLAYER --- */
.plyr {
    display: none;
}

/* --- PLAYER SECTIONS --- */
.album-art-container {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--background-color) 0%, var(--oracle-glow) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--tier-accent);
}

.album-art-container img {
    display: none; /* Hide the image since we're using wave animation */
}

/* Enhanced Wave Animation for Oracle */
.wave-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
}

.wave-bar {
    width: 4px;
    background: var(--brand-color);
    border-radius: 2px;
    animation: wave 1.2s ease-in-out infinite;
    opacity: 0.9;
    box-shadow: 0 0 3px var(--tier-accent);
}

.wave-bar:nth-child(1) { height: 25px; animation-delay: 0s; }
.wave-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
.wave-bar:nth-child(3) { height: 55px; animation-delay: 0.2s; }
.wave-bar:nth-child(4) { height: 30px; animation-delay: 0.3s; }
.wave-bar:nth-child(5) { height: 45px; animation-delay: 0.4s; }
.wave-bar:nth-child(6) { height: 65px; animation-delay: 0.5s; }
.wave-bar:nth-child(7) { height: 40px; animation-delay: 0.6s; }
.wave-bar:nth-child(8) { height: 50px; animation-delay: 0.7s; }
.wave-bar:nth-child(9) { height: 35px; animation-delay: 0.8s; }
.wave-bar:nth-child(10) { height: 60px; animation-delay: 0.9s; }
.wave-bar:nth-child(11) { height: 30px; animation-delay: 1s; }
.wave-bar:nth-child(12) { height: 45px; animation-delay: 1.1s; }

@keyframes wave {
    0%, 100% { 
        transform: scaleY(0.4);
        opacity: 0.7;
    }
    50% { 
        transform: scaleY(1.2);
        opacity: 1;
    }
}

/* Pause animation when music is paused */
.wave-container.paused .wave-bar {
    animation-play-state: paused;
}

.track-info-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.track-details h2 {
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0 0 4px 0;
    color: var(--text-color-primary);
    text-shadow: 0 0 5px var(--oracle-glow);
}

.track-details p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-color-secondary);
}

.plus-icon button {
    background: none;
    border: 2px solid var(--tier-accent);
    color: var(--tier-accent);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 0 5px var(--oracle-glow);
}

.plus-icon button:hover {
    border-color: var(--text-color-primary);
    color: var(--text-color-primary);
    box-shadow: 0 0 10px var(--oracle-glow);
}

/* --- PROGRESS BAR & TIME --- */
.progress-container {
    margin-bottom: 16px;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-color-secondary);
    margin-top: 8px;
}

/* Custom Seek Slider Styles */
.seek-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: var(--slider-track-color);
    outline: none;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
}

.seek-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: var(--brand-color);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 8px var(--brand-color), 0 0 15px var(--oracle-glow);
    margin-top: -6px;
}

.seek-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: var(--brand-color);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 8px var(--brand-color), 0 0 15px var(--oracle-glow);
    margin-top: -6px;
}

.seek-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) var(--progress-percent, 0%), var(--slider-track-color) var(--progress-percent, 0%), var(--slider-track-color) 100%);
}

.seek-slider::-moz-range-track {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) var(--progress-percent, 0%), var(--slider-track-color) var(--progress-percent, 0%), var(--slider-track-color) 100%);
}

/* --- CONTROLS --- */
.controls-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.control-btn {
    background: none;
    border: none;
    color: var(--text-color-secondary);
    cursor: pointer;
    padding: 8px;
    transition: color 0.2s ease;
}

.control-btn:hover {
    color: var(--text-color-primary);
}

.control-btn.active {
    color: var(--brand-color);
    stroke: var(--brand-color);
}

.control-btn svg {
    display: block;
}

.play-pause-btn {
    background-color: var(--brand-color);
    color: var(--text-color-primary);
    border-radius: 50%;
    width: 68px;
    height: 68px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 15px var(--brand-color), 0 0 30px var(--oracle-glow);
    transition: transform 0.2s ease;
}

.play-pause-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px var(--brand-color), 0 0 40px var(--oracle-glow);
}

.play-pause-btn svg {
    width: 36px;
    height: 36px;
    fill: currentColor;
}

/* --- DOWNLOAD LINKS (TIER 3 SPECIFIC) --- */
.download-container {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--tier-accent);
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.download-link {
    color: var(--text-color-secondary);
    text-decoration: none;
    font-size: 0.85rem;
    padding: 8px 16px;
    border: 1px solid var(--tier-accent);
    border-radius: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 0 5px var(--oracle-glow);
}

.download-link:hover {
    color: var(--text-color-primary);
    border-color: var(--brand-color);
    background-color: var(--oracle-glow);
    box-shadow: 0 0 10px var(--oracle-glow);
}

.creator-notice {
    margin-top: 16px;
    text-align: center;
    padding: 12px;
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
    border-radius: 8px;
    border: 1px solid rgba(0, 255, 255, 0.3);
}

.creator-notice p {
    color: var(--tier-accent);
    font-size: 0.8rem;
    margin: 0;
    font-style: italic;
}

/* --- DESKTOP / WIDE SCREEN LAYOUT --- */
@media (min-width: 768px) {
    #custom-player-container {
        max-width: 800px;
        display: flex;
        align-items: center;
        padding: 20px;
    }

    .album-art-container {
        width: 200px;
        flex-shrink: 0;
        margin-bottom: 0;
        margin-right: 24px;
    }

    .album-art-container img {
        margin-bottom: 0;
        display: none;
    }

    .player-main-content {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
}
</style>

<!-- PLAYER HTML STRUCTURE -->
<div id="custom-player-container">
    <div class="tier-badge">Neon Oracle</div>
    <audio id="audioPlayer" preload="metadata"></audio>
    
    <div class="album-art-container">
        <img id="albumArt" src="https://via.placeholder.com/500" alt="Album Art">
        <div class="wave-container paused" id="waveAnimation">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>
    </div>
    
    <div class="player-main-content">
        <div class="track-info-container">
            <div class="track-details">
                <h2 id="trackTitle">Track Title</h2>
                <p id="trackArtist">Artist Name</p>
            </div>
            <div class="plus-icon">
                <button id="addToPlaylistBtn">+</button>
            </div>
        </div>
        
        <div class="progress-container">
            <input id="progressBar" type="range" value="0" step="0.01" class="seek-slider">
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="totalDuration">0:00</span>
            </div>
        </div>
        
        <div class="controls-container">
            <button id="shuffleBtn" class="control-btn shuffle-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="16 16 21 16 21 21"></polyline><line x1="4" y1="4" x2="11" y2="11"></line></svg>
            </button>
            <button id="prevBtn" class="control-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>
            </button>
            <button id="playPauseBtn" class="control-btn play-pause-btn">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
            </button>
            <button id="nextBtn" class="control-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="m6 18 8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
            <button id="repeatBtn" class="control-btn repeat-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
            </button>
        </div>
        
        <!-- TIER 3 SPECIFIC: Full Downloads + Creator Features -->
        <div class="download-container">
            <a id="downloadMp3Btn" href="#" download class="download-link">Download MP3</a>
            <a id="downloadWavBtn" href="#" download class="download-link">Download WAV</a>
        </div>
        
        <div class="creator-notice">
            <p>âœ¨ For creators who don't just follow the vibe - they define it. Inner circle access.</p>
        </div>
    </div>
</div>

<!-- INCLUDE THE PLYR.JS SCRIPT -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<!-- PLAYER JAVASCRIPT -->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // TIER 3 CONFIGURATION
        const TIER_CONFIG = {
            tier: 3,
            name: "Neon Oracle",
            maxTracks: 30, // 30 tracks at signup
            monthlyTracks: 15, // 15+ new tracks monthly
            streamingOnly: false,
            allowDownloads: true,
            downloadFormats: ['mp3', 'wav'], // Both MP3 and WAV downloads
            streamingFormats: ['wav'], // High-quality WAV streaming
            creatorFeatures: true
        }; 

        // 1. FETCH PLAYLIST DATA FROM DATABASE
        let playlist = [];
        
        // Function to get API base URL (works both locally and when deployed)
        function getApiBaseUrl() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return `${window.location.protocol}//${window.location.host}`;
            }
            return 'https://music-player-hadbg3c8cwazh4gm.canadacentral-01.azurewebsites.net';
        }

        // Fetch songs from database with tier filtering
        // Fetch user's selected songs from their personal playlist
        async function loadPlaylist() {
            try {
                // Get current user from Memberstack first
                if (typeof window.$memberstackDom === 'undefined') {
                    throw new Error('Memberstack not loaded');
                }
                
                const member = await window.$memberstackDom.getCurrentMember();
                if (!member) {
                    console.warn('No user logged in - showing empty playlist');
                    playlist = [];
                    showEmptyPlaylistMessage();
                    return;
                }
                
                // Fetch user's personal playlist from backend
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/user-playlist/${member.id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('User has no playlist yet');
                        playlist = [];
                        showEmptyPlaylistMessage();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const userPlaylist = await response.json();
                playlist = userPlaylist;
                
                console.log(`Loaded ${playlist.length} tracks from user's personal playlist`);
                
                if (playlist.length > 0) {
                    loadTrack(0);
                } else {
                    showEmptyPlaylistMessage();
                }
                
            } catch (error) {
                console.error('Error loading user playlist:', error);
                playlist = [];
                showEmptyPlaylistMessage();
            }
        }
        
        // Show message when user has no songs selected
        function showEmptyPlaylistMessage() {
            // Update the track info to show guidance
            const trackTitleEl = document.getElementById('trackTitle');
            const trackArtistEl = document.getElementById('trackArtist');
            
            if (trackTitleEl && trackArtistEl) {
                trackTitleEl.textContent = 'No Songs Selected';
                trackArtistEl.textContent = 'Visit the Music Library to add songs to your playlist';
            }
            
            // Disable controls
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (playPauseBtn) {
                playPauseBtn.disabled = true;
                playPauseBtn.style.opacity = '0.5';
            }
        }

        // 2. GET PLAYER ELEMENTS
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalDurationEl = document.getElementById('totalDuration');
        const repeatBtn = document.getElementById('repeatBtn');
        const trackTitleEl = document.getElementById('trackTitle');
        const trackArtistEl = document.getElementById('trackArtist');
        const albumArtEl = document.getElementById('albumArt');
        const downloadMp3Btn = document.getElementById('downloadMp3Btn');
        const downloadWavBtn = document.getElementById('downloadWavBtn');
        const waveAnimation = document.getElementById('waveAnimation');

        const playIcon = `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
        const pauseIcon = `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        let currentTrackIndex = 0;
        let isShuffleEnabled = false;
        let shuffledPlaylist = [];
        let shuffleIndex = 0;
        
        // 3. INITIALIZE PLYR
        const player = new Plyr('#audioPlayer', { controls: [] });
        window.player = player;
        
        // 4. CORE FUNCTIONS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function createShuffledPlaylist() {
            const indices = Array.from({ length: playlist.length }, (_, i) => i);
            shuffledPlaylist = shuffleArray(indices);
            shuffleIndex = shuffledPlaylist.indexOf(currentTrackIndex);
        }
        
        function getNextTrackIndex() {
            if (isShuffleEnabled) {
                shuffleIndex = (shuffleIndex + 1) % shuffledPlaylist.length;
                return shuffledPlaylist[shuffleIndex];
            } else {
                return (currentTrackIndex + 1) % playlist.length;
            }
        }
        
        function getPreviousTrackIndex() {
            if (isShuffleEnabled) {
                shuffleIndex = (shuffleIndex - 1 + shuffledPlaylist.length) % shuffledPlaylist.length;
                return shuffledPlaylist[shuffleIndex];
            } else {
                return (currentTrackIndex - 1 + playlist.length) % playlist.length;
            }
        }
        
        function loadTrack(trackIndex) {
            const track = playlist[trackIndex];
            
            // Use highest quality WAV for streaming
            player.source = { 
                type: 'audio', 
                title: track.title, 
                sources: [{ src: track.streamingUrl, type: 'audio/wav' }] 
            };
            
            trackTitleEl.textContent = track.title;
            trackArtistEl.textContent = track.artist;
            albumArtEl.src = track.artworkUrl;
            
            // Update download links - Both MP3 and WAV for Tier 3
            if (TIER_CONFIG.allowDownloads) {
                downloadMp3Btn.href = track.downloadUrl;
                downloadMp3Btn.style.display = 'inline-block';
                
                if (track.wavUrl && track.wavUrl !== track.downloadUrl) {
                    downloadWavBtn.href = track.wavUrl;
                    downloadWavBtn.style.display = 'inline-block';
                } else {
                    downloadWavBtn.href = track.streamingUrl;
                    downloadWavBtn.style.display = 'inline-block';
                }
            }

            currentTrackIndex = trackIndex;
            
            // Reset progress bar
            progressBar.value = 0;
            progressBar.style.setProperty('--progress-percent', '0%');
            currentTimeEl.textContent = '0:00';
            totalDurationEl.textContent = '0:00';
        }

        // 5. EVENT LISTENERS
        playPauseBtn.addEventListener('click', () => { player.togglePlay(); });
        player.on('play', () => { 
            playPauseBtn.innerHTML = pauseIcon; 
            waveAnimation.classList.remove('paused');
        });
        player.on('pause', () => { 
            playPauseBtn.innerHTML = playIcon; 
            waveAnimation.classList.add('paused');
        });
        player.on('ready', () => { 
            const duration = player.duration; 
            if (isFinite(duration)) { 
                totalDurationEl.textContent = formatTime(duration); 
                progressBar.max = duration; 
            } 
        });
        
        player.on('loadedmetadata', () => {
            const duration = player.duration;
            if (isFinite(duration)) {
                totalDurationEl.textContent = formatTime(duration);
                progressBar.max = duration;
            }
        });
        player.on('timeupdate', () => { 
            const currentTime = player.currentTime;
            const duration = player.duration;
            currentTimeEl.textContent = formatTime(currentTime);
            
            if (duration > 0) {
                progressBar.value = currentTime;
                progressBar.max = duration;
                const progress = (currentTime / duration) * 100;
                progressBar.style.setProperty('--progress-percent', `${progress}%`);
            }
        });

        player.on('ended', () => { nextBtn.click(); });
        
        progressBar.addEventListener('input', (e) => { 
            const seekTime = parseFloat(e.target.value);
            player.currentTime = seekTime;
            
            const duration = player.duration;
            if (duration > 0) {
                const progress = (seekTime / duration) * 100;
                progressBar.style.setProperty('--progress-percent', `${progress}%`);
            }
        });
        
        progressBar.addEventListener('change', (e) => {
            const seekTime = parseFloat(e.target.value);
            player.currentTime = seekTime;
        });
        nextBtn.addEventListener('click', () => { 
            currentTrackIndex = getNextTrackIndex(); 
            loadTrack(currentTrackIndex); 
            player.play(); 
        });
        prevBtn.addEventListener('click', () => { 
            currentTrackIndex = getPreviousTrackIndex(); 
            loadTrack(currentTrackIndex); 
            player.play(); 
        });
        repeatBtn.addEventListener('click', () => { 
            repeatBtn.classList.toggle('active'); 
            player.loop = !player.loop; 
        });
        
        const shuffleBtn = document.getElementById('shuffleBtn');
        shuffleBtn.addEventListener('click', () => {
            isShuffleEnabled = !isShuffleEnabled;
            shuffleBtn.classList.toggle('active');
            
            if (isShuffleEnabled) {
                createShuffledPlaylist();
                console.log('Shuffle enabled');
            } else {
                console.log('Shuffle disabled');
            }
        });
        
        // 6. INITIALIZE FIRST TRACK
        await loadPlaylist();
    });
</script>

<!-- END OF CUSTOM PLAYER EMBED CODE - TIER 3: NEON ORACLE -->
