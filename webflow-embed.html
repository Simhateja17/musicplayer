<!-- START OF CUSTOM PLAYER EMBED CODE -->

<style>
/* --- BASIC SETUP & THEME --- */
:root {
    --brand-color: #00BFFF; /* Neon Blue */
    --background-color: #121212;
    --surface-color: #000000; /* Made it pure black for better embedding */
    --text-color-primary: #FFFFFF;
    --text-color-secondary: #B3B3B3;
    --slider-track-color: #404040;
}

/* The body styles won't apply inside an embed, so we style the container directly */
#custom-player-container {
    background-color: var(--surface-color);
    color: var(--text-color-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    margin: 40px auto; /* Center the player on the page */
}

/* --- HIDE THE DEFAULT PLYR PLAYER --- */
.plyr {
    display: none;
}

/* --- PLAYER SECTIONS --- */
.album-art-container {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--background-color) 0%, rgba(0, 191, 255, 0.1) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.album-art-container img {
    display: none; /* Hide the image since we're using wave animation */
}

/* Wave Animation Styles */
.wave-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
}

.wave-bar {
    width: 4px;
    background: var(--brand-color);
    border-radius: 2px;
    animation: wave 1.5s ease-in-out infinite;
    opacity: 0.8;
}

.wave-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
.wave-bar:nth-child(2) { height: 35px; animation-delay: 0.1s; }
.wave-bar:nth-child(3) { height: 50px; animation-delay: 0.2s; }
.wave-bar:nth-child(4) { height: 25px; animation-delay: 0.3s; }
.wave-bar:nth-child(5) { height: 40px; animation-delay: 0.4s; }
.wave-bar:nth-child(6) { height: 60px; animation-delay: 0.5s; }
.wave-bar:nth-child(7) { height: 35px; animation-delay: 0.6s; }
.wave-bar:nth-child(8) { height: 45px; animation-delay: 0.7s; }
.wave-bar:nth-child(9) { height: 30px; animation-delay: 0.8s; }
.wave-bar:nth-child(10) { height: 55px; animation-delay: 0.9s; }
.wave-bar:nth-child(11) { height: 25px; animation-delay: 1s; }
.wave-bar:nth-child(12) { height: 40px; animation-delay: 1.1s; }

@keyframes wave {
    0%, 100% { 
        transform: scaleY(0.3);
        opacity: 0.6;
    }
    50% { 
        transform: scaleY(1);
        opacity: 1;
    }
}

/* Pause animation when music is paused */
.wave-container.paused .wave-bar {
    animation-play-state: paused;
}

.track-info-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.track-details h2 {
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0 0 4px 0;
    color: var(--text-color-primary);
}

.track-details p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-color-secondary);
}

.plus-icon button {
    background: none;
    border: 2px solid var(--text-color-secondary);
    color: var(--text-color-secondary);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.plus-icon button:hover {
    border-color: var(--text-color-primary);
    color: var(--text-color-primary);
}

/* --- PROGRESS BAR & TIME --- */
.progress-container {
    margin-bottom: 16px;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-color-secondary);
    margin-top: 8px;
}

/* Custom Seek Slider Styles */
.seek-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: var(--slider-track-color);
    outline: none;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
}

.seek-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: var(--brand-color);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px var(--brand-color), 0 0 10px var(--brand-color);
    margin-top: -5px; /* Center the thumb vertically */
}

.seek-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--brand-color);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 5px var(--brand-color), 0 0 10px var(--brand-color);
    margin-top: -5px; /* Center the thumb vertically */
}

.seek-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) var(--progress-percent, 0%), var(--slider-track-color) var(--progress-percent, 0%), var(--slider-track-color) 100%);
}

.seek-slider::-moz-range-track {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) var(--progress-percent, 0%), var(--slider-track-color) var(--progress-percent, 0%), var(--slider-track-color) 100%);
}

/* --- CONTROLS --- */
.controls-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.control-btn {
    background: none;
    border: none;
    color: var(--text-color-secondary);
    cursor: pointer;
    padding: 8px;
    transition: color 0.2s ease;
}

.control-btn:hover {
    color: var(--text-color-primary);
}

.control-btn.active {
    color: var(--brand-color);
    stroke: var(--brand-color);
}

.control-btn svg {
    display: block;
}

.play-pause-btn {
    background-color: var(--brand-color);
    color: var(--text-color-primary);
    border-radius: 50%;
    width: 64px;
    height: 64px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 10px var(--brand-color), 0 0 20px rgba(0, 191, 255, 0.5);
    transition: transform 0.2s ease;
}

.play-pause-btn:hover {
    transform: scale(1.05);
}

.play-pause-btn svg {
    width: 32px;
    height: 32px;
    fill: currentColor;
}

/* --- DOWNLOAD LINKS --- */
.download-container {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--slider-track-color);
    display: flex;
    justify-content: center;
    gap: 20px;
}

.download-link {
    color: var(--text-color-secondary);
    text-decoration: none;
    font-size: 0.85rem;
    padding: 8px 16px;
    border: 1px solid var(--slider-track-color);
    border-radius: 20px;
    transition: all 0.2s ease;
}

.download-link:hover {
    color: var(--text-color-primary);
    border-color: var(--brand-color);
    background-color: rgba(0, 191, 255, 0.1);
}

/* --- DESKTOP / WIDE SCREEN LAYOUT --- */
@media (min-width: 768px) {
    #custom-player-container {
        max-width: 800px;
        display: flex;
        align-items: center;
        padding: 20px;
    }

    .album-art-container {
        width: 200px;
        flex-shrink: 0;
        margin-bottom: 0;
        margin-right: 24px;
    }

    .album-art-container img {
        margin-bottom: 0;
        display: none; /* Keep image hidden in desktop view too */
    }

    .player-main-content {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
}
</style>

<!-- PLAYER HTML STRUCTURE -->
<div id="custom-player-container">
    <audio id="audioPlayer" preload="metadata"></audio>
    
    <div class="album-art-container">
        <img id="albumArt" src="https://via.placeholder.com/500" alt="Album Art">
        <div class="wave-container paused" id="waveAnimation">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>
    </div>
    
    <div class="player-main-content">
        <div class="track-info-container">
            <div class="track-details">
                <h2 id="trackTitle">Track Title</h2>
                <p id="trackArtist">Artist Name</p>
            </div>
            <div class="plus-icon">
                <button id="addToPlaylistBtn">+</button>
            </div>
        </div>
        
        <div class="progress-container">
            <input id="progressBar" type="range" value="0" step="0.01" class="seek-slider">
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="totalDuration">0:00</span>
            </div>
        </div>
        
        <div class="controls-container">
            <button id="shuffleBtn" class="control-btn shuffle-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="16 16 21 16 21 21"></polyline><line x1="4" y1="4" x2="11" y2="11"></line></svg>
            </button>
            <button id="prevBtn" class="control-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>
            </button>
            <button id="playPauseBtn" class="control-btn play-pause-btn">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
            </button>
            <button id="nextBtn" class="control-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="m6 18 8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
            <button id="repeatBtn" class="control-btn repeat-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
            </button>
        </div>
        
        <div class="download-container">
            <a id="downloadMp3Btn" href="#" download class="download-link">Download MP3</a>
            <a id="downloadWavBtn" href="#" download class="download-link">Download WAV</a>
        </div>
    </div>
</div>

<!-- INCLUDE THE PLYR.JS SCRIPT -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<!-- PLAYER JAVASCRIPT -->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. FETCH PLAYLIST DATA FROM DATABASE
        let playlist = [];
        
        // Function to get API base URL (works both locally and when deployed)
        function getApiBaseUrl() {
            // If running locally with the server
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return `${window.location.protocol}//${window.location.host}`;
            }
            // If embedded in Webflow or other site, you'll need to update this with your deployed API URL
            return 'https://your-deployed-api-url.com'; // Replace with your actual deployed API URL
        }

        // Fetch songs from database
        async function loadPlaylist() {
            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/songs`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const songs = await response.json();
                playlist = songs;
                
                console.log('Loaded playlist from database:', playlist);
                
                // Initialize player with first track if playlist is not empty
                if (playlist.length > 0) {
                    loadTrack(0);
                } else {
                    console.warn('No songs found in database');
                }
                
            } catch (error) {
                console.error('Error loading playlist from database:', error);
                
                // Fallback to default playlist if database is unavailable
                playlist = [
                    {
                        "title": "Ain't Got No Time",
                        "artist": "Digitized Sensation",
                        "streamingUrl": "https://ds-stream.b-cdn.net/ds-vol1/aintgottime.wav",
                        "downloadUrl": "https://ds-stream.b-cdn.net/ds-vol1/aintgottime.wav",
                        "artworkUrl": "https://via.placeholder.com/500?text=Ain't+Got+No+Time",
                        "wavUrl": "https://ds-stream.b-cdn.net/ds-vol1/aintgottime.wav"
                    },
                    {
                        "title": "All the Way Real",
                        "artist": "Digitized Sensation",
                        "streamingUrl": "https://ds-stream.b-cdn.net/ds-vol1/allthewayreal.wav",
                        "downloadUrl": "https://ds-stream.b-cdn.net/ds-vol1/allthewayreal.wav",
                        "artworkUrl": "https://via.placeholder.com/500?text=All+the+Way+Real",
                        "wavUrl": "https://ds-stream.b-cdn.net/ds-vol1/allthewayreal.wav"
                    },
                    {
                        "title": "Amant de Coeur",
                        "artist": "Digitized Sensation",
                        "streamingUrl": "https://ds-stream.b-cdn.net/ds-vol1/amantdecoeur.wav",
                        "downloadUrl": "https://ds-stream.b-cdn.net/ds-vol1/amantdecoeur.wav",
                        "artworkUrl": "https://via.placeholder.com/500?text=Amant+de+Coeur",
                        "wavUrl": "https://ds-stream.b-cdn.net/ds-vol1/amantdecoeur.wav"
                    }
                ];
                
                console.log('Using fallback playlist');
                if (playlist.length > 0) {
                    loadTrack(0);
                }
            }
        }

        // 2. GET PLAYER ELEMENTS
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalDurationEl = document.getElementById('totalDuration');
        const repeatBtn = document.getElementById('repeatBtn');
        const trackTitleEl = document.getElementById('trackTitle');
        const trackArtistEl = document.getElementById('trackArtist');
        const albumArtEl = document.getElementById('albumArt');
        const downloadMp3Btn = document.getElementById('downloadMp3Btn');
        const downloadWavBtn = document.getElementById('downloadWavBtn');
        const waveAnimation = document.getElementById('waveAnimation');

        const playIcon = `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
        const pauseIcon = `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        let currentTrackIndex = 0;
        let isShuffleEnabled = false;
        let shuffledPlaylist = [];
        let shuffleIndex = 0;
        
        // 3. INITIALIZE PLYR
        const player = new Plyr('#audioPlayer', { controls: [] });
        window.player = player;
        
        // 4. CORE FUNCTIONS (UPDATED TO USE YOUR DATA STRUCTURE)
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // Shuffle function to randomize playlist
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Create shuffled playlist
        function createShuffledPlaylist() {
            const indices = Array.from({ length: playlist.length }, (_, i) => i);
            shuffledPlaylist = shuffleArray(indices);
            shuffleIndex = shuffledPlaylist.indexOf(currentTrackIndex);
        }
        
        // Get next track index based on shuffle state
        function getNextTrackIndex() {
            if (isShuffleEnabled) {
                shuffleIndex = (shuffleIndex + 1) % shuffledPlaylist.length;
                return shuffledPlaylist[shuffleIndex];
            } else {
                return (currentTrackIndex + 1) % playlist.length;
            }
        }
        
        // Get previous track index based on shuffle state
        function getPreviousTrackIndex() {
            if (isShuffleEnabled) {
                shuffleIndex = (shuffleIndex - 1 + shuffledPlaylist.length) % shuffledPlaylist.length;
                return shuffledPlaylist[shuffleIndex];
            } else {
                return (currentTrackIndex - 1 + playlist.length) % playlist.length;
            }
        }
        
        function loadTrack(trackIndex) {
            const track = playlist[trackIndex];
            
            // **UPDATED HERE** to use your keys: streamingUrl, artworkUrl, etc.
            player.source = { 
                type: 'audio', 
                title: track.title, 
                sources: [{ src: track.streamingUrl, type: 'audio/wav' }] 
            };
            
            trackTitleEl.textContent = track.title;
            trackArtistEl.textContent = track.artist;
            albumArtEl.src = track.artworkUrl;
            
            // Update download links - show both MP3 and WAV if available
            downloadMp3Btn.href = track.downloadUrl;
            
            // Show WAV download button if WAV URL is available
            if (track.wavUrl && track.wavUrl !== track.downloadUrl) {
                downloadWavBtn.href = track.wavUrl;
                downloadWavBtn.style.display = 'inline-block';
            } else {
                downloadWavBtn.href = track.downloadUrl || track.streamingUrl;
                downloadWavBtn.style.display = 'inline-block';
            }

            currentTrackIndex = trackIndex;
            
            // Reset progress bar
            progressBar.value = 0;
            progressBar.style.setProperty('--progress-percent', '0%');
            currentTimeEl.textContent = '0:00';
            totalDurationEl.textContent = '0:00';
        }

        // 5. EVENT LISTENERS (No changes needed here)
        playPauseBtn.addEventListener('click', () => { player.togglePlay(); });
        player.on('play', () => { 
            playPauseBtn.innerHTML = pauseIcon; 
            waveAnimation.classList.remove('paused');
        });
        player.on('pause', () => { 
            playPauseBtn.innerHTML = playIcon; 
            waveAnimation.classList.add('paused');
        });
        player.on('ready', () => { 
            const duration = player.duration; 
            if (isFinite(duration)) { 
                totalDurationEl.textContent = formatTime(duration); 
                progressBar.max = duration; 
            } 
        });
        
        // Also update duration when metadata loads
        player.on('loadedmetadata', () => {
            const duration = player.duration;
            if (isFinite(duration)) {
                totalDurationEl.textContent = formatTime(duration);
                progressBar.max = duration;
            }
        });
        player.on('timeupdate', () => { 
            const currentTime = player.currentTime;
            const duration = player.duration;
            currentTimeEl.textContent = formatTime(currentTime);
            
            // Update progress bar value and visual state
            if (duration > 0) {
                progressBar.value = currentTime;
                progressBar.max = duration;
                const progress = (currentTime / duration) * 100;
                progressBar.style.setProperty('--progress-percent', `${progress}%`);
            }
        });

        player.on('ended', () => { nextBtn.click(); });
        
        // Handle seeking when user clicks/drags on progress bar
        progressBar.addEventListener('input', (e) => { 
            const seekTime = parseFloat(e.target.value);
            player.currentTime = seekTime;
            
            // Update visual progress immediately
            const duration = player.duration;
            if (duration > 0) {
                const progress = (seekTime / duration) * 100;
                progressBar.style.setProperty('--progress-percent', `${progress}%`);
            }
        });
        
        // Handle clicking on progress bar to seek
        progressBar.addEventListener('change', (e) => {
            const seekTime = parseFloat(e.target.value);
            player.currentTime = seekTime;
        });
        nextBtn.addEventListener('click', () => { 
            currentTrackIndex = getNextTrackIndex(); 
            loadTrack(currentTrackIndex); 
            player.play(); 
        });
        prevBtn.addEventListener('click', () => { 
            currentTrackIndex = getPreviousTrackIndex(); 
            loadTrack(currentTrackIndex); 
            player.play(); 
        });
        repeatBtn.addEventListener('click', () => { 
            repeatBtn.classList.toggle('active'); 
            player.loop = !player.loop; 
        });
        
        // Shuffle button functionality
        const shuffleBtn = document.getElementById('shuffleBtn');
        shuffleBtn.addEventListener('click', () => {
            isShuffleEnabled = !isShuffleEnabled;
            shuffleBtn.classList.toggle('active');
            
            if (isShuffleEnabled) {
                // Create a new shuffled playlist when shuffle is enabled
                createShuffledPlaylist();
                console.log('Shuffle enabled');
            } else {
                console.log('Shuffle disabled');
            }
        });
        
        // 6. INITIALIZE FIRST TRACK
        // Load playlist from database and initialize player
        await loadPlaylist();
    });
</script>

<!-- END OF CUSTOM PLAYER EMBED CODE -->
